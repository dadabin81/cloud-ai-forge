# Binario API - Cloudflare Worker Configuration
# Docs: https://developers.cloudflare.com/workers/wrangler/configuration/

name = "binario-api"
main = "src/index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# Environment Variables
[vars]
ENVIRONMENT = "production"

# AI Binding - Workers AI
[ai]
binding = "AI"

# D1 Database - Replace database_id after running: wrangler d1 create binario-db
[[d1_databases]]
binding = "DB"
database_name = "binario-db"
database_id = "d0c7ca63-d243-4b48-806b-044124fffc1c"

[[kv_namespaces]]
binding = "KV"
id = "71d0d869b4dc4aacb524e8524f6ddd0d"

# ============ Vectorize for RAG ============
# Create with: wrangler vectorize create binario-embeddings --preset @cf/baai/bge-base-en-v1.5
[[vectorize]]
binding = "VECTORIZE_INDEX"
index_name = "binario-embeddings"

# ============ Durable Objects for Agents SDK ============
[[durable_objects.bindings]]
name = "BINARIO_AGENT"
class_name = "BinarioAgent"

[[durable_objects.bindings]]
name = "SANDBOX_PROJECT"
class_name = "SandboxProject"

# Durable Object migrations
# v1: Create the Durable Object classes first
[[migrations]]
tag = "v1"
new_classes = ["BinarioAgent", "SandboxProject"]

# v2: Enable SQLite storage for the classes
[[migrations]]
tag = "v2"
new_sqlite_classes = ["BinarioAgent", "SandboxProject"]

# ============ Workflows for Multi-step Agents ============
[[workflows]]
binding = "RESEARCH_WORKFLOW"
name = "research-workflow"
class_name = "ResearchWorkflow"

[[workflows]]
binding = "RAG_WORKFLOW"
name = "rag-workflow"
class_name = "RAGWorkflow"

# Development environment
[env.development]
name = "binario-api-dev"

[env.development.vars]
ENVIRONMENT = "development"

[[env.development.durable_objects.bindings]]
name = "BINARIO_AGENT"
class_name = "BinarioAgent"

# Staging environment
[env.staging]
name = "binario-api-staging"

[env.staging.vars]
ENVIRONMENT = "staging"

[[env.staging.durable_objects.bindings]]
name = "BINARIO_AGENT"
class_name = "BinarioAgent"

# Production custom domain (optional)
# Uncomment after configuring in Cloudflare Dashboard
# [[routes]]
# pattern = "api.binario.dev/*"
# zone_name = "binario.dev"

# Observability
[observability]
enabled = true

# Build configuration
[build]
command = "npm run build"

# Limits - increased for agents
[limits]
cpu_ms = 100
